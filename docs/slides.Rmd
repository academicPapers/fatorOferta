---
title: "Fator Oferta"
subtitle: "Contextualização, Conceitos e Paradigmas, Estado da Arte e Aplicações"
author: "Luiz Fernando Palin Droubi"
institute: "Diretor Técnico da SOBREA"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css: [default, metropolis, metropolis-fonts]
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, echo = FALSE, warning = FALSE, 
                      message = FALSE, prompt = T,
                      fig.align = "center", fig.height = 4.5,
                      fig.path = "images/", dev = "svg")
options(htmltools.dir.version = FALSE)
library(sjPlot)
library(ggplot2)
library(cowplot)
theme_set(theme_cowplot())
library(ggvis)
library(stargazer)
library(effects)
library(lmtest)
```


class: inverse, center, middle

# Contextualização

---
# Contextualização

* Dados de transação:

--
  - Proxy para o valor de mercado
  
--

  - **Se** tratarem-se de *arms' lenght transactions*
  
--

  - Transações com valores muito discrepantes podem ser de vendas ocorridas em situações diferentes das que caracterizam as *arm's lenght transactions*

--

* Dados de oferta:

--

  - Proxy para o valor de mercado
  
--

  - **Se** os anúncios forem *validados*
  
--

  - Necessidade de um passo a mais: a qual distância do valor de mercado 
  encontram-se os dados de oferta?

---
class: inverse, center, middle

# Conceitos e Paradigmas

---
# Conceitos e Paradigmas

* Preços de mercado vs. Valor de Mercado (**VM**)

--

* Definições neoclássicas do **VM**:

--

  - Market price is the amount actually paid in a particular transaction, while market value is a hypothetical or estimated sale price that would result from careful consideration by the buyer and seller of all data, with primary reliance 
on those data that reflect the actions of responsible, prudent buyers and 
sellers under conditions of a fair sale (Spinney, 2010). 

--

  - IVSC: the estimated amount for which a property should exchange on the date 
of valuation between a willing buyer and a willing seller **in an arm’s length transaction** after proper marketing wherein the parties had each acted 
knowledgeably, prudently and without compulsion (French, 2006, p. 87).

--

  - Valor de mercado é a quantia mais provável pela qual se negociaria voluntariamente e conscientemente um bem, em uma data de referência, dentro das condições do mercado vigente (NBR 14653-01/2019).
  
---
# Conceitos e Paradigmas

* Crítica das definições de **VM** a partir da teoria dos custos de transação:
  
--

  - most of the literature on the property market is written as though it was the very paradigm of a neo-classical perfect market—many buyers, many sellers, homogeneous product, full information etc (Evans, 1995, p. 6; also see 
comment by Watkins, 1998, p. 57).

--
  
  - actors in real-life markets are faced with positive transaction costs, 
  mainly arising from incomplete information.

--

  - once transaction costs are introduced, the acquisition of unlimited 
  knowledge becomes too expensive or impossible.
  
--

* Em um extremo, tem-se a condição de mercado perfeito, e num outro extremo, 
tem-se a condição de mercado inexistente. Entre as duas situações, partindo do
extremo de mercado inexistente, à medida que os custos de transação diminuem,
ruma-se para a condição de mercado perfeito, onde existem muitos compradores,
muitos vendedores e informação perfeita, *i.e.* os custos de transação são
iguais a zero.

--

  - It would seem therefore that valuation theory is faced with the simultaneity 
problem akin to that of quantum physics where, in this case, market value cannot exist simultaneously with the need for valuation. Valuers are required when transaction costs are high but at this point market value does not exist. 
Conversely, valuers are not required when transaction costs are zero and market value has emerged.

---
background-image: url(https://news.berkeley.edu/wp-content/uploads/2014/07/cats300.jpg)
background-size: contain

# O gato de Schrodinger

---
class: inverse, center, middle

# Estado da arte

---
# Estado da arte

* They (valuers) are producers and sellers of information about property markets, 
performing the important function of bringing together buyers and sellers who generally lack information. It is argued here that valuers are not merely 
passive gatherers of market information. On the contrary, they actively 
create information where none existed to enable property markets to function.

--

* By estimating the ‘market value’ of a property, a valuer is effectively 
laying down a rule for the market in question.

--

  - It must be stressed that valuers do not consciously set out to impose these 
norms on the market, but this nevertheless is the effect of their actions. Once ‘market value’ has been provided, market participants need not personally search 
for the distribution of prices. 

--

  - Further, it provides an anchor upon which bargaining between the 
  participants can be based. ‘Market value’ is thus a device for lowering
  transaction costs. Its function is to stabilise market expectations by 
  providing pricing information.
  
--

* Conclusão:

--

  - market value is normative
  
--

  - market value may be established for any market, whether thin or actively 
  traded.

--

  - valuers can and do inﬂuence, even determine, prices in property markets.
  

---
# Estado da arte

* Criação de valor de mercado *ex nihilo*:

--

  - Windhoek, Namíbia (Mooya, 2008): Na falta de melhores informações, o mercado estava ancorado nos valores constantes do cadastro municipal, que estava com 
valores desatualizados;
    
--

  - Um avaliador foi consultado a respeito do valor de mercado de uma 
propriedade em terras de propriedade comunal, que não eram possíveis de ser
negociadas até aquele momento. Não havia informação mercadológica disponível,       portanto, para a avaliação dessa terra.

--

  - De uma maneira ou de outra o avaliador, para a satisfação do seu cliente,
entregou um laudo de avaliação da área.

--
  
  - Após a avaliação, um mercado sobre aquelas terras se desenvolveu, ancorado
no valor da avaliação prévia.
    
--

* Em suma, os avaliadores não são meros observadores do mercado, que trabalham
com as informações disponíveis, produzindo laudos friamente. Os avaliadores 
injetam informação no mercado.

---
# Estado da Arte: O fator oferta

* Utilizado para homogeneizar os dados de oferta, $P_L$, com os dados de 
transações, $P_R$.

--

* Assumido multiplicativo: $P_{R} = \lambda P_{L}$ (Chinloy, 1980).

--

* Horowitz (1992) remove a hipótese multiplicativa e ajusta um modelo 
econométrico para estimar os valores de venda à partir dos valores listados e
das características dos imóveis, com a hipótese que $P_R < P_L$

--

* Haurin et al. (2013) mostram que, em períodos de *boom*, no MI os preços de
venda podem superar os preços de oferta.

--

* Novas estratégias de venda podem afetar o valor do fator oferta. Enquanto nas
estratégias convencionais o valor reservado é menor do que o valor ofertado, nas
novas estratégias de venda é facultado ao proprietário ofertar o seu imóvel a 
um valor mais baixo que o de mercado, criando assim condições para um maior 
número de ofertas (leilão).

---
background-image: url(./images/1-s2.0-S1051137713000041-gr1.jpg)
background-size: contain

# Fator oferta vs. Tempo

---
# Estado da Arte: O fator oferta
    
## Conclusão

* A forma do fator oferta depende do mercado em questão e do momento em análise;

--

* O avaliador deve analisar os dados de oferta e transação para tomar a melhor
decisão sobre a relação momentânea entre oferta e transação e a melhor maneira
de modelá-la;

--

* O avaliador deve prospectar o mercado para averiguar a eventual existência de
diferentes estratégias de venda nos preços ofertados;

--

* Na falta de melhores informações do mercado, o avaliador deve estar ciente de
que estará inserindo informação no mercado. O melhor a fazer é estabelecer uma hipótese clara sobre a relação oferta/transação e deixar isso claro em seu laudo.
    
---
class: inverse, center, middle

# Aplicações

---
# Modelo de regressão na forma direta 


$$VU = (1 - 0,15.Fonte)(3000 - 0,25.Area + \varepsilon)$$

```{r, echo = TRUE}
set.seed(2)
area <- runif(100, min = 250, max = 10000)
venda <- rbinom(100, 1, .5)
vu <- (1-.15*venda)*(3000 - .25*area + rnorm(100, 0, 150))
dados <- data.frame(VU = vu, Area = area, 
                 Fonte = factor(venda, 
                                labels = c("Oferta", "Venda")))
```

---
# Análise Exploratória

```{r dados1, fig.cap="Dados randômicos de oferta (em vermelho) e transação (em verde)"}
ggplot(dados, aes(x = Area, y = VU, color = Fonte)) +
  geom_point() +
  stat_smooth(method = "lm", se = FALSE)
```

---
# Modelo mal especificado

.pull-left[

```{r, echo = TRUE}
fit <- lm(VU ~ Area + Fonte, data = dados)
summary(fit)
```

]

.pull-right[

```{r}
bptest(fit)
qqnorm(residuals(fit)); qqline(residuals(fit), col = 2)
```

]


---
# Modelo mal especificado

```{r dados1a, fig.cap="Dados randômicos de oferta (em vermelho) e transação (em verde)"}
ggplot(dados, aes(x = Area, y = VU)) +
  geom_abline(intercept = coef(fit)[1], slope = coef(fit)[2], 
              color = "red") +
  geom_abline(intercept = coef(fit)[1] + coef(fit)[3], slope = coef(fit)[2], 
              color = "blue") +
  geom_point(aes(color = Fonte))
```

---
# Modelo bem especificado

.pull-left[

```{r, echo = TRUE}
fit1 <- lm(VU ~ Area*Fonte, data = dados)
summary(fit1)
```
]

.pull-right[

```{r}
bptest(fit1)
qqnorm(residuals(fit1)); qqline(residuals(fit1), col = 2)
```

]

---
# Opção: aplicação prévia do fator oferta

.pull-left[

```{r, echo = TRUE}
dados <- within(dados, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU, .85*VU))
```

* Coeficiente de variação dos dados crus:

```{r, echo = TRUE}
sd(dados$VU)/mean(dados$VU)
```

* Coeficiente de variação dos dados homogeneizados:

```{r, echo = TRUE}
sd(dados$VUhom)/mean(dados$VUhom)
```

]

.pull-right[

```{r dadosHomogeneizados, fig.cap="Dados homogeneizados."}
ggplot(dados, aes(x = Area, y = VUhom, color = Fonte)) +
  geom_point() + stat_smooth(method = "lm", se = FALSE)
```

]

---
# Opção: aplicação prévia do fator oferta

* Modelo:

```{r, echo = TRUE}
fithom <- lm(VUhom ~ Area, dados)
summary(fithom)
```


---
# Resumo

```{r, results='asis', include = FALSE}
stargazer(fit, fit1, fithom,
          header = FALSE, type = "html", table.placement = "H",
          title="Comparação dos modelos",
          #dep.var.labels=c("$log(Valor_{oferta})$","$log(Valor_{Hom})$"),
          ci = TRUE, ci.level = .80, report = "vcst*", single.row = T,
          intercept.bottom = FALSE, intercept.top = TRUE,
          decimal.mark = ",", digit.separator = ".",
          digits = 2, star.cutoffs = c(0.30, 0.20, 0.10),
          notes.label = "Notas:",
          font.size = "footnotesize"
          )
```

```{r}
tab_model(fit, fit1, fithom)
```


---
# Previsão de valores

.pull-left[

```{r, echo = TRUE, highlight.output=c(2)}
new250 <- 
  data.frame(Area = 250, Fonte = "Venda")
predict(fit, newdata = new250,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fit1, newdata = new250,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom, newdata = new250,
        interval = "confidence", level = .80)
```
]

.pull-right[

```{r, echo = TRUE, highlight.output=c(2)}
new10000 <- 
  data.frame(Area = 10000, Fonte = "Venda")
predict(fit, newdata = new10000,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fit1, newdata = new10000,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom, newdata = new10000,
        interval = "confidence", level = .80)
```

]

---
# Dados lognormais

$$VU = \exp(7,5 - 0,25\cdot \log(Area) - 0,15\cdot Fonte + \varepsilon)$$

```{r, echo = TRUE}
set.seed(2)
area <- runif(100, min = 250, max = 5000)
venda <- rbinom(100, 1, .5)
lvu <- 7.5 - .25*log(area) - .15*venda + rnorm(100, mean = 0, sd = .05)
dados <- data.frame(VU = exp(lvu), Area = area, 
                 Fonte = factor(venda, labels = c("Oferta", "Venda")))
```

---
# Dados lognormais: análise exploratória

```{r lognormalExploratoria, fig.width=9, fig.cap="Análise exploratória. Dados lognormais."}
p1 <- ggplot(dados, aes(x = Area, y = VU, color = Fonte)) + 
  geom_point() + stat_smooth(se = FALSE)
p2 <- ggplot(dados, aes(x = log(Area), y = log(VU), color = Fonte)) +
  geom_point() + stat_smooth(method = "lm", se = FALSE)
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```


---
# Modelo bem especificado

```{r, echo = TRUE}
fit2 <- lm(log(VU) ~ log(Area) + Fonte, data = dados)
```

```{r}
plot(predictorEffects(fit2, residuals=TRUE),
     partial.residuals=list(smooth=TRUE, span=0.5,  lty="dashed"),
     axes=list(grid=FALSE,x=list(rotate=30)))
```

---
# Modelo bem especificado

```{r fit2Diagnostics, fig.cap="Modelo correto. Fator oferta. Dados lognormais.",, fig.show = "hold", out.width="38%"}
plot(fit2)
```


---
# Opção: Aplicação prévia do Fator Oferta

.pull-left[
```{r, echo = TRUE}
dados <- within(dados, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU, .85*VU))
fithom2 <- lm(log(VUhom) ~ log(Area), dados)
summary(fithom2)
```
]

.pull-right[

```{r, echo = TRUE}
sd(dados$VU)/mean(dados$VU)
```

```{r, echo = TRUE}
sd(dados$VUhom)/mean(dados$VUhom)
```
]

---
# Opção: Aplicação prévia do Fator Oferta

```{r, fig.width=9}
p1 <- ggplot(dados, aes(x = Area, y = VUhom, color = Fonte)) +
  geom_point() +
  stat_smooth(se = FALSE)
p2 <- ggplot(dados, aes(x = log(Area), y = log(VUhom), color = Fonte)) +
  geom_point() +
  stat_smooth(method = "lm", se = FALSE)
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---
# Diagnóstico modelo com dados homogeneizados

```{r fit2homDiagnostics, fig.cap="Modelo com dados homogeneizados. Dados lognormais.",, fig.show = "hold", out.width="38%"}
plot(fithom2)
```

---
# Resumo dos modelos

```{r}
tab_model(fit2, fithom2)
```

---
# Previsão de valores

.pull-left[

```{r, echo = TRUE, highlight.output=c(2)}
new250 <- 
  data.frame(Area = 250, Fonte = "Venda")
exp(predict(fit2, newdata = new250,
        interval = "confidence", level = .80))
```


```{r, echo = TRUE, highlight.output=c(2)}
exp(predict(fithom2, newdata = new250,
        interval = "confidence", level = .80))
```
]

.pull-right[

```{r, echo = TRUE, highlight.output=c(2)}
new5000 <- 
  data.frame(Area = 5000, Fonte = "Venda")
exp(predict(fit2, newdata = new5000,
        interval = "confidence", level = .80))
```

```{r, echo = TRUE, highlight.output=c(2)}
exp(predict(fithom2, newdata = new5000,
        interval = "confidence", level = .80))
```

]

---
# Outras transformações

$$VU = (1-0,15\cdot Fonte)(50 - 0,01\cdot Area + \varepsilon)^2$$

```{r, echo = TRUE}
set.seed(2)
area <- runif(100, min = 250, max = 5000)
venda <- rbinom(100, 1, .5)
sqrtvu <- 70 - .01*area + rnorm(100, mean = 0, sd = 2)
vu <- (1-.15*venda)*sqrtvu^2
dados <- data.frame(VU = vu, Area = area, 
                 Fonte = factor(venda, labels = c("Oferta", "Venda")))
```

---
# Outras transformações: análise exploratória

```{r, fig.width = 9}
p1 <- ggplot(dados, aes(x = Area, y = VU, color = Fonte)) +
  geom_point() + stat_smooth(se = FALSE)
p2 <- ggplot(dados, aes(x = Area, y = sqrt(VU), color = Fonte)) +
  geom_point() + stat_smooth(se = FALSE)
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---
# Modelo mal especificado

```{r, echo = TRUE}
fit3 <- lm(sqrt(VU) ~ Area + Fonte, data = dados)
summary(fit3)
```

---
# Modelo mal especificado

```{r fit3Diagnostics, fig.cap="Modelo mal especificado. Fator oferta.", fig.show="hold", out.width="38%"}
plot(fit3)
```

---
# Modelo correto

```{r, echo = TRUE}
fit4 <- lm(sqrt(VU) ~ Area*Fonte, data = dados)
summary(fit4)
```

---
# Modelo correto

```{r rightModel3, fig.cap="Fator oferta com transformação raiz quadrada. Modelo especificado corretamente.", fig.show = 'hold', out.width="50%"}
plot(predictorEffect("Area", fit4),
     lines=list(multiline=TRUE))
plot(predictorEffect("Area", fit4), 
     lines=list(multiline=TRUE),
     axes=list(y=list(transform=appraiseR::sqr, lab="VU")))
```

---
# Modelo correto

```{r fit4Diagnostics, fig.cap="Modelo mal especificado. Fator oferta.", fig.show="hold", out.width="38%"}
plot(fit4)
```

---
# Opção: aplicação prévia do fator oferta

.pull-left[

```{r, echo = TRUE}
dados <- within(dados, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU, .85*VU))
fithom3 <- lm(sqrt(VUhom) ~ Area, dados)
summary(fithom3)
```

]

.pull-right[

* Coeficiente de variação dos dados crus:

```{r, echo = TRUE}
sd(dados$VU)/mean(dados$VU)
```

* Coeficiente de variação dos dados homogeneizados:

```{r, echo = TRUE}
sd(dados$VUhom)/mean(dados$VUhom)
```

]

---
# Opção: aplicação prévia do fator oferta

```{r dadosHomogeneizados3, fig.cap="Dados homogeneizados."}
ggplot(dados, aes(x = Area, y = VUhom, color = Fonte)) +
  geom_point() + stat_smooth(se = FALSE)
```

---
# Resumo

```{r, results='asis', include = FALSE}
stargazer(fit3, fit4, fithom3,
          header = FALSE, type = "html", table.placement = "H",
          title="Comparação dos modelos",
          #dep.var.labels=c("$log(Valor_{oferta})$","$log(Valor_{Hom})$"),
          ci = TRUE, ci.level = .80, report = "vcst*", single.row = T,
          intercept.bottom = FALSE, intercept.top = TRUE,
          decimal.mark = ",", digit.separator = ".",
          digits = 2, star.cutoffs = c(0.30, 0.20, 0.10),
          notes.label = "Notas:",
          font.size = "footnotesize"
          )
```

```{r}
tab_model(fit3, fit4, fithom3, digits = 3)
```

---
# Previsão de valores

.pull-left[

```{r, echo = TRUE, highlight.output=c(2)}
new250 <- 
  data.frame(Area = 250, Fonte = "Venda")
predict(fit3, newdata = new250,
        interval = "confidence", level = .80)^2
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fit4, newdata = new250,
        interval = "confidence", level = .80)^2
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom3, newdata = new250,
        interval = "confidence", level = .80)^2
```
]

.pull-right[

```{r, echo = TRUE, highlight.output=c(2)}
new5000 <- 
  data.frame(Area = 5000, Fonte = "Venda")
predict(fit3, newdata = new5000,
        interval = "confidence", level = .80)^2
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fit4, newdata = new5000,
        interval = "confidence", level = .80)^2
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom3, newdata = new5000,
        interval = "confidence", level = .80)^2
```

]

---
# Fator Oferta na regressão múltipla

```{r, echo = TRUE}
library(MASS)
##                X1       X2      Y
sigma <- matrix(c(16  ,    15,  10.2,
                  15  ,    25,    8,
                  10.2,     8,    9),
                ncol = 3, byrow = T)
set.seed(1)
dados <- mvrnorm(n=200,
              mu=c(100, 50, 30),
              Sigma=sigma)
colnames(dados) <- c("X1", "X2", "y")
dados <- as.data.frame(dados)
# cor(dados)
# cov(dados)
dados$Fonte <- rbinom(200, 1, .5)
dados$y <- (1 - .15*dados$Fonte)*dados$y
dados$Fonte <- factor(dados$Fonte, labels = c("Oferta", "Venda"))
```

---
# Fator Oferta na regressão múltipla

```{r}
p1 <- ggplot(dados, aes(y = y, x = X1, color = Fonte)) +
  geom_point()
p2 <-  ggplot(dados, aes(y = y, x = X2, color = Fonte)) +
  geom_point()
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```


---
# Modelo mal especificado

```{r, echo = TRUE}
fitMult <- lm(y ~ X1 + X2 + Fonte, dados)
summary(fitMult)
```

---
# Modelo mal especificado

```{r fitMultDiagnostics, fig.cap="Modelo mal especificado. Fator oferta.",, out.width="38%", fig.show="hold"}
plot(fitMult)
```

---
# Análise Exploratória

```{r}
library(broom)
coeffs <- coef(fitMult)
dados <- augment(fitMult, dados)
```


```{r}
p1 <- ggplot(dados, aes(x = X1, y = .resid + coeffs[2]*X1 + coeffs[1], 
                        color = Fonte)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  geom_abline(intercept = coeffs[1], slope = coeffs[2]) +
  labs(y = "Component + Partial Residuals")
p2 <- ggplot(dados, aes(x = X2, y = .resid + coeffs[3]*X2 + coeffs[1], 
                        color = Fonte)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  geom_abline(intercept = coeffs[1], slope = coeffs[3]) +
  labs(y = "Component + Partial Residuals")
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---
# Modelo Correto

```{r, echo = TRUE}
fitMult2 <- lm(y ~ (X1 + X2)*Fonte, data = dados)
summary(fitMult2)
```

---
# Modelo Correto

```{r, fig.cap="Regressão Múltiplo. Modelo Correto. Fator Oferta.", out.width="50%", fig.show = "hold"}
plot(predictorEffect("X1", fitMult2),
     lines=list(multiline=TRUE))
plot(predictorEffect("X2", fitMult2), 
     lines=list(multiline=TRUE))
```

---
# Modelo Correto

```{r fitMul2tDiagnostics, fig.cap="Modelo mal especificado. Fator oferta.",, out.width="38%", fig.show="hold"}
plot(fitMult2)
```

---
# Opção: aplicação prévia do fator oferta

.pull-left[

```{r, echo = TRUE}
dados <- within(dados, 
                yhom <- ifelse(Fonte == "Venda", 
                                y, .85*y))
fithom4 <- lm(yhom ~ X1 + X2, dados)
summary(fithom4)
```

]

.pull-right[

* Coeficiente de variação dos dados crus:

```{r, echo = TRUE}
sd(dados$y)/mean(dados$y)
```

* Coeficiente de variação dos dados homogeneizados:

```{r, echo = TRUE}
sd(dados$yhom)/mean(dados$yhom)
```

]

---
# Previsão de valores

.pull-left[

```{r, echo = TRUE, highlight.output=c(2)}
new90_40 <- 
  data.frame(X1 = 90, X2 = 40, Fonte = "Venda")
predict(fitMult, newdata = new90_40,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fitMult2, newdata = new90_40,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom4, newdata = new90_40,
        interval = "confidence", level = .80)
```
]

.pull-right[

```{r, echo = TRUE, highlight.output=c(2)}
new110_60 <- 
  data.frame(X1 = 110, X2 = 60, Fonte = "Venda")
predict(fitMult, newdata = new110_60,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fitMult2, newdata = new110_60,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom4, newdata = new110_60,
        interval = "confidence", level = .80)
```

]



---
# Efeitos do Fator Oferta sobre IC e IP



---
class: inverse, center, middle

# Conclusão

---
# Conclusão

* A modelagem e aplicação do Fator Oferta deve ser feita com cuidado. Deve-se
ter em mente que assumir que $V_{venda} = \lambda V_{oferta}$ é apenas uma 
hipótese que deve ser verificada

* A análise exploratória é fundamental para a percepção da realidade do mercado
antes da modelagem

* A modelagem deve levar em conta a hipótese feita para o fator oferta

* A má especificação do fator oferta pode levar a modelos tendenciosos, que 
podem produzir más previsões de valores, especialmente nos extremos dos dados

* O fator oferta também influencia no cômputo dos intervalos de confiança e
predição. É um erro comparar valores de mercado com intervalos obtidos com 
dados de oferta antes de um tratamento destes intervalos.
