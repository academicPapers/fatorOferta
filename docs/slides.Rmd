---
title: "Fator Oferta"
subtitle: "Contextualização, Conceitos e Paradigmas, Estado da Arte e Aplicações"
author: "Luiz Fernando Palin Droubi"
institute: "Diretor Técnico da SOBREA"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
encoding: "utf-8"
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css: [default, metropolis, metropolis-fonts, "scrollable.css"]
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, echo = FALSE, warning = FALSE, 
                      message = FALSE, prompt = T,
                      fig.align = "center", fig.height = 4.5,
                      fig.path = "images/", dev = "svg")
options(htmltools.dir.version = FALSE)
library(sjPlot)
library(ggplot2)
library(ggExtra)
library(cowplot)
theme_set(theme_cowplot())
library(ggvis)
library(stargazer)
library(effects)
library(lmtest)
library(mosaic)
library(car)
```

```{r, load_refs, include=FALSE, cache=FALSE}
library(RefManageR)
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "authoryear",
           style = "markdown",
           hyperlink = TRUE,
           dashed = FALSE)
bib <- ReadBib("./assets/references.bib", check = FALSE)
```

class: inverse, center, middle

# Contextualização

```{r xaringan-tile-view, echo=FALSE}
xaringanExtra::use_tile_view()
xaringanExtra::use_progress_bar(color = "#0051BA", location = "top")
```

```{r xaringan-logo, echo=FALSE}
xaringanExtra::use_logo(
  image_url = "https://sobrea.org.br/wp-content/uploads/elementor/thumbs/Logo-SOBREA-Facebook-Redondo-512x512-1-p6rqwuzy75km0rog7cducjs0umjma86c1yl75qi0ts.png",
  link_url = "https://sobrea.org.br/",
  position = xaringanExtra::css_position(top = "1em", right = "1em")
)
```

```{r xaringanExtra-search, echo=FALSE}
xaringanExtra::use_search(show_icon = TRUE)
```


```{r xaringanExtra-clipboard, echo=FALSE}
xaringanExtra::use_clipboard()
```

---
# Contextualização

## Dados de transação:

--

* Proxy para o valor de mercado
  
--

  - **Se** tratarem-se de *arms' lenght transactions*, ou seja, se as transações
  forem entre partes independentes.
  
--

  - Transações com valores muito discrepantes podem ser de vendas ocorridas em 
  situações diferentes das que caracterizam as *arm's lenght transactions*

--

## Dados de oferta:

--

* Proxy para o valor de mercado
  
--

  - **Se** os anúncios forem *validados*
  
--

  - Necessidade de um passo a mais: a qual distância do valor de mercado 
  encontram-se os dados de oferta?

---
class: inverse, center, middle

# Conceitos e Paradigmas

---
# Conceitos e Paradigmas

## Definições neoclássicas do **VM**:

--

* Preços de mercado vs. Valor de Mercado (**VM**)

--

  - O preço de mercado é o valor efetivamente pago em uma determinada transação, 
enquanto **valor de mercado é um preço de venda hipotético ou estimado** que 
resultaria da consideração cuidadosa pelo comprador e vendedor de todos os dados, 
com confiança nos dados que refletem as ações de compradores e vendedores 
responsáveis e prudentes, sob condições de uma venda justa `r AutoCite(bib, 'spinney')`.

--

  - IVSC: o **valor de mercado é a quantia estimada** pela qual uma propriedade 
  deve ser negociada, na data de avaliação, entre um promitente comprador e um 
  promitente vendedor, entre partes independentes, após um tempo adequado de 
  exposição ao mercado, em que ambas as partes ajam com conhecimento,
  prudência e sem compulsão (French, 2006, p. 87).

--

  - **Valor de mercado é a quantia mais provável** pela qual se negociaria
  voluntariamente e conscientemente um bem, em uma data de referência, dentro
  das condições do mercado vigente `r AutoCite(bib, "NBR1465301")`.
  
---
# Conceitos e Paradigmas

## Valor mais provável vs. valor mais alto

* Alguns autores entendem que o valor de mercado é o valor mais alto da 
distribuição de probabilidades `r AutoCite(bib, 'mooya2009')`:

--

  - **Tome-se o exemplo de uma única propriedade colocada no mercado. Esta 
  propriedade atrairá uma distribuição de ofertas normal de potenciais 
  compradores**. O preço mais alto estará na extremidade superior da 
  distribuição, enquanto o preço mais provável, em termos estatísticos, estará
  em seu centro.

--

  - Levando em contra que os preços reais de mercado são usados como *proxies*
  para o valor de mercado, a questão que se coloca é em que ponto da distribuição
  a propriedade será negociada. Na prática, **um vendedor buscará a maior oferta**
  possível que ele esteja ciente. 

--

  - **Nestas circunstâncias, a propriedade será negociada próximo à extremidade
  superior da distribuição, não na média ou na moda da distribução**. De fato,
  assumindo que os vendedores são 'racionais', todos as vendas observadas 
  serão ao maior valor possível de ser obtido. Isto leva muitos avaliadores a 
  definir o **valor de mercado como o máximo preço possível**.

---
# Conceitos e Paradigmas

## Valor mais provável vs. valor mais alto

* Porém, isto vai de encontro ao senso comum e à intuição:

--

  - Definir o valor de mercado em termos da extremidade superior de uma
  distribuição normal está, no entanto, em desacordo com a maioria das
  definições e com a intuição. **Quanto mais próximo se chega da extremidade
  superior da distribuição, mais se chega próximo a negociações atípicas ou
  especiais** e, portanto, menos representativas do sentimento do mercado o
  preço de venda se torna.

--

  - **A maioria das definições de valor de mercado assumem compradores e 
  vendedores típicos**. Intuitivamente, a maior parte das pessoas não 
  reconheceria compras especiais (ou vendas forçadas) como boas evidências do 
  valor de mercado.

--

  - **O senso comum requer que o valor de mercado seja 'representativo'** do 
mercado em questão e deva, então, se localizar **no centro da distribuição**.
Avaliadores que concordam com esta visão definem o valor de mercado com o valor
mais provável.

---
# Conceitos e Paradigmas

## Valor mais provável vs. valor mais alto

### Como conciliar as duas definições de valor de mercado?

--

* Segundo `r Citet(bib, 'mooya2009')`, a confusão pode ser facilmente 
resolvida deixando explícitas as hipóteses em relação às informações disponíveis 
ao vendedor e a extensão do mercado em questão. **Se o vendedor tem informação 
total sobre todas as ofertas potenciais, a propriedade será vendida ao maior 
preço**.

--

  - **A realidade, contudo, é que o vendedor não terá a informação completa
  sobre o tamanho e a distribuição das ofertas**. Do ponto de vista do vendedor, 
  a venda terá lugar ao máximo preço possível. Do ponto de vista de um 
  observador onisciente, contudo, a propriedade será negociada, *a priori*, ao 
  preço mais provável. Este preço deverá ser um preço 'médio', apenas porque 
  haverá mais compradores naquele ponto e, então, uma mais alta probabilidade de 
  consumar a negociação.

--

  - Deve-se lembrar que o **valor de mercado é uma estimativa de um preço de
  venda que não se realizou e provavelmenten nunca se realizará**. O preço 
  realizado é, portanto, inteiramente uma questão de probabilidade

--

* As reflexões acima se referem à localização do valor de mercado dentro de uma
distribuição de probabilidade de dados de venda. E em relação aos dados de 
oferta? O valor de mercado pode ser encontrado dentro da distribuição de 
probabilidades de dados de oferta? Em que região?

---
# Conceitos e Paradigmas

## Onde se situa o **VM** na distribuição de dados de oferta?

--

* **Hipótese:** Em um mercado desaquecido, as negociações se concretizam com 
grandes descontos em relação aos preços anunciados! O valor de mercado se 
encontra distante da região central da distribuição de probabilidades de dados 
de oferta!

```{r}
p <- gf_dist("norm", mean = 100, sd = 10, kind = "density", resolution = 50,
        color = "red", size = 2, 
         fill = "red", alpha = 0.5, geom = "area") %>%
  gf_dist("norm", mean = 150, sd = 10, kind = "density", resolution = 50,
          color = "blue", size = 2, 
          fill = "blue", alpha = 0.5, geom = "area")
p + 
  annotate("text", label = "Compradores", 
           x = 80, y = .03, 
           size = 4, color = "red") + 
  annotate("text", label = "Vendedores", 
           x = 170, y = .03,
           size = 4, color = "blue") +
  annotate("text", label = "Fator Oferta",
           x = 137.5, y = .045,
           size = 4, color = "black") +
  geom_vline(xintercept = 125) +
  geom_vline(xintercept = 150) +
  geom_segment(x = 125, xend = 150, y = .0425, yend = .0425,
               arrow = arrow(length=unit(0.30,"cm"), 
                             ends="both", type = "closed"))+
  scale_y_continuous(expand = c(0.015, 0))
```

---
# Conceitos e Paradigmas

## Onde se situa o **VM** na distribuição de dados de oferta?

--

* **Hipótese:** Em um mercado aquecido, o valor de mercado se situa próximo ao 
centro da distribuição dos dados de oferta. As negociações se dão com pouco 
desconto, ou ainda, em valores acima dos preços anunciados!

```{r}
p <- gf_dist("norm", mean = 140, sd = 10, kind = "density", resolution = 50,
        color = "red", size = 2, 
         fill = "red", alpha = 0.5, geom = "area") %>%
  gf_dist("norm", mean = 150, sd = 10, kind = "density", resolution = 50,
          color = "blue", size = 2, 
          fill = "blue", alpha = 0.5, geom = "area")
p + 
  annotate("text", label = "Compradores", 
           x = 120, y = .03, 
           size = 4, color = "red") + 
  annotate("text", label = "Vendedores", 
           x = 170, y = .03,
           size = 4, color = "blue") +
  annotate("text", label = "Fator Oferta",
           x = 156, y = .0425,
           size = 4, color = "black") +
  geom_vline(xintercept = 145) +
  geom_vline(xintercept = 150) +
  geom_segment(x = 145, xend = 150, y = .0425, yend = .0425,
               arrow = arrow(length=unit(0.30,"cm"), 
                             ends="both", type = "closed")) +
  scale_y_continuous(expand = c(0.015, 0))
```

---
# Conceitos e Paradigmas

## Crítica das definições de **VM** elaboradas a partir da teoria dos custos de transação
  
--

* a maior parte da literatura sobre o mercado imobiliário é escrita sobre o 
paradigma do mercados perfeitos neoclássicos - muitos compradores, muitos 
vendedores, produtos homogêneos, informações completas, etc (Evans, 1995, p. 6; 
ver tb comentários de Watkins, 1998, p. 57).

--
  
  - atores nos mercados reais, no entanto, se deparam com custos de transação 
  positivos, especialmente advindos de informação incompleta.

--

  - uma vez que os custos de transação são introduzidos, a aquisição de 
  conhecimento ilimitado torna-se muito cara, ou ainda, impossível.
  
--

* Em um extremo, tem-se a condição de mercado perfeito, e num outro extremo, 
tem-se a condição de mercado inexistente. Entre as duas situações, partindo do
extremo de mercado inexistente, à medida que os custos de transação diminuem,
ruma-se para a condição de mercado perfeito, onde existem muitos compradores,
muitos vendedores e informação perfeita, *i.e.* os custos de transação são
iguais a zero.

---
background-image: url(https://news.berkeley.edu/wp-content/uploads/2014/07/cats300.jpg)
background-size: contain

# O gato de Schrodinger

---
class: inverse, center, middle

# Estado da arte

---
# Estado da arte

* It would seem therefore that valuation theory is faced with the simultaneity 
problem akin to that of quantum  
physics where, in this case, **market value cannot exist simultaneously with the 
need for valuation**. Valuers are required when transaction costs are high but 
at this point market value does not exist. Conversely, valuers are not required 
when transaction costs are zero and market value has emerged 
`r Citet(bib, 'mooya2009', after = ', p. 694-695')`.

--

* **Eles (os avaliadores) são produtores e vendedores de informação sobre os 
mercados imobiliários**, realizando a importante função de unir compradores e 
vendedores, para os quais, usualmente, a informação é faltante. É argumentado
aqui que os **avaliadores não são meros coletores passivos de informação de
mercado**. Pelo contrário, **eles ativamente criam informação onde nenhuma 
existe, para possibilitar que os mercados imobiliários funcionem**.

--

* Ao estimar o 'valor de mercado' de uma propriedade, um avaliador está 
efetivamente estabelecendo uma regra para o mercado em questão

--

  - Deve ser enfatizado que os avaliadores não se propõem conscientemente a 
  impor essas normas ao mercado, mas, mesmo assim, este é o efeito de suas ações. 
  Uma vez que o 'valor de mercado' foi fornecido, os participantes do mercado não 
  precisam pesquisar pessoalmente a distribuição de preços.

--

  - Além disso, o 'valor de mercado' fornece uma âncora sobre a qual a 
  negociação entre os participantes podem ser baseados. **'Valor de mercado' é, 
  portanto, um dispositivo para diminuir os custos de transação. Sua função é 
  estabilizar as expectativas do mercado por meio do fornecimento de informações 
  sobre preços**.

---
# Estado da arte

* `r Citet(bib, 'erba2019', after = ', p.40')`: En el área catastral es 
justamente la georreferenciación que permite estructurar bases de datos  
con la ubicación, forma y dimensiones de cada parcela, dándole continuidad a la 
información territorial.
  
--
  
* En el área de catastro económico no pasa lo mismo, los datos no son 
comparables por falta de estandarización y de una referencia única [...] Para 
salir de estas trampas es necesario que se establezca una política catastral 
clara y objetiva, que referencie a todos los valores de los inmuebles a un 
sistema único el cual, inobjetablemente, debería ser el mercado inmobiliario.

--

* Não é isto, então, justamente o que falta na AL? Não apenas ao CTM, como 
argumenta Erba, um referenciamento ao mercado imobiliário, como, inversamente,
também falta ao mercado imobiliário um sistema de ancoragem, que é a informação 
cadastral!?

--

  - Se as informações cadastrais últimas estivessem disponíveis aos avaliadores, 
  não haveria problema para estimar o fator oferta.
  
--

  - Se as informações cadastrais últimas estivessem disponíveis aos avaliadores,
  estes não necessitariam utilizar "fatores consagrados", através dos quais
  estão a inserir uma informação no mercado, de origem duvidosa.
  
--

  - Se as informações cadatrais últimas estivessem disponíveis aos proprietários,
  potenciais compradores e corretores, as ofertas ficariam, provavelmente, 
  ancoradas nos preços das últimas transações, dando estabilidade ao mercado.
  
---
# Estado da arte

* Criação de valor de mercado *ex nihilo*:

--

  - Windhoek, Namíbia `r AutoCite(bib, 'mooya2009')`: Na falta de melhores 
  informações, o mercado estava ancorado nos valores constantes do cadastro 
  municipal, que estava com valores desatualizados;
    
--

  - Um avaliador foi consultado a respeito do valor de mercado de uma 
propriedade em terras de propriedade comunal, que não eram possíveis de ser
negociadas até aquele momento. Não havia informação mercadológica disponível, 
portanto, para a avaliação dessa terra.

--

  - De uma maneira ou de outra o avaliador, para a satisfação do seu cliente,
entregou um laudo de avaliação da área.

--
  
  - Após a avaliação, um mercado sobre aquelas terras se desenvolveu, ancorado
no valor da avaliação prévia.
    
--

* Em suma:

--

  - O valor de mercado é normativo!
  
--

  - O valor de mercado pode ser estabelecido para qualquer mercado, tenha ele
  liquidez ou não.

--

  - avaliadores podem e realmente influenciam, ou até determinam os preços em
  mercados imobiliários.

---
# Estado da Arte: Estimação do fator oferta

* Utilizado para homogeneizar os dados de oferta com os dados de transações,
visando estimar o valor de  
mercado.

--

* Assumido multiplicativo: $P_{R} = \lambda P_{L}$ `r AutoCite(bib, "chinloy")`.

--

* `r Citet(bib, "horowitz")` remove a hipótese multiplicativa e ajusta um modelo 
econométrico para estimar os valores de venda à partir dos valores listados e
das características dos imóveis, com a hipótese que $P_R < P_L$

--

* `r Citet(bib, "haurin")` mostram que, em períodos de *boom*, no MI os preços 
de venda podem superar os preços de oferta.

--

* Novas estratégias de venda podem afetar o valor do fator oferta. Enquanto nas
estratégias convencionais o valor reservado é menor do que o valor ofertado, nas
novas estratégias de venda é facultado ao proprietário ofertar o seu imóvel a 
um valor mais baixo que o de mercado, criando assim condições para um maior 
número de ofertas (leilão).

---
background-image: url(./images/1-s2.0-S1051137713000041-gr1.jpg)
background-size: contain

# Fator oferta vs. Tempo

---
# Estado da Arte: O fator oferta
    
## Conclusão

* A relação entre oferta/transação depende do mercado em questão e do momento em 
análise;

--

* O avaliador deve analisar os dados de oferta e transação para tomar a melhor
decisão sobre a relação momentânea entre ofertas e transações e a melhor maneira
de modelá-la;

--

* O avaliador deve prospectar o mercado para averiguar a eventual existência de
diferentes estratégias de venda nos preços ofertados;

--

* Na falta de melhores informações do mercado, o avaliador deve estar ciente de
que estará inserindo informação no mercado. O melhor a fazer é estabelecer uma 
hipótese clara sobre a relação oferta/transação e deixar isso claro em seu laudo.
    
---
class: inverse, center, middle

# Aplicações

---
# Estimação do Fator Oferta

* `r TextCite(bib, "NBR1465302")`: 

--

  - 9.2.1.3 **É permitida a utilização de tratamento prévio dos preços**
  observados, **limitado a um único fator de homogeneização**, desde que
  fundamentado conforme 8.2.1.4.2, sem prejuízo dos ajustes citados em 9.2.1.2
  (**exemplo: aplicação do fator de fonte para a transformação de preços de 
  oferta para as condições de transação**). 
  
--

  - **Os fatores devem ser calculados por metodologia científica**, como citado 
  em 8.2.1.4.3, justificados do ponto de vista teórico e prático, com a inclusão
  de validação, quando pertinente [...]
  
--

  - Para a utilização deste tratamento **é recomendável que seja evitado** o uso 
  de **fatores que**, aplicados isoladamente em relação ao avaliando ou ao 
  paradigma, **heterogeneizem os valores originais**. Essa recomendação só é 
  válida com a confirmação do efeito de heterogeneização, após a aplicação 
  conjunta dos fatores. 
  
--

* `r TextCite(bib, 'ibapeSP')`:

--

  - 10.1 A superestimativa dos dados de oferta (elasticidade dos negócios)
  deverá ser descontada do valor total pela aplicação do fator médio observado
  no mercado. **Na impossibilidade da sua determinação, pode ser aplicado o fator
  consagrado 0,9** (desconto de 10% sobre o preço original pedido)...
  
--

  - Forma mista: 10.6 - 1. A utilização dos fatores deve ser na forma de 
  somatório, **após a consideração do fator oferta**.
  
---
# Estimação do Fator Oferta

* `r Citet(bib, "lima2006")` mostrou como estimar os fatores cientificamente, 
*i.e.* a partir de modelos de regressão linear, tanto  
para a forma aditiva como para a forma multiplicativa de utilização dos fatores.

--

* Basicamente, Lima mostrou que:

--

  - se os fatores são aplicados na forma aditiva, estes devem ser estimados por 
  um modelo aditivo de regressão linear, da forma:

$$VU \sim \beta_1 X_1 + \beta_2X_2 + \ldots + \beta_kX_k + \varepsilon$$

--

  - se os fatores são aplicados na forma multiplicativa, estes devem ser 
  estimados por um modelo de regressão na escala logarítmica, da forma:
  
$$ log(VU) \sim \beta_1X_1 + \beta_2X_2 +  \ldots + \beta_kX_k + \varepsilon$$
--

* Porém, Lima não conseguiu chegar a uma forma para a estimação do fator oferta
quando da utilização da forma mista, definida pelo IBAPE/SP, sugerindo *testar
diversos fatores fonte $F_f$, até encontrar aquele que mais ajustasse o modelo
de regressão para os demais fatores*.

---
# Estimação do Fator Oferta

* Argumento que pode-se estimar o Fator oferta ou Fator fonte para a forma mista
através do seguinte modelo de regressão:

$$VU \sim Fonte*(\beta_1X_1 + \beta_2X_2 +  \ldots + \beta_kX_k + \varepsilon)$$

--

* Ou seja, na forma mista, o Fator oferta pode ser estimado através de um modelo
de regressão incluindo a variável dicotômica $Fonte$ (0 se oferta, 1 se venda),
interagindo com as outras variáveis explicativas na forma aditiva.

---
# Estimação do Fator Oferta

## Modelo de regressão na forma direta 


$$VU = (1 - 0,15.Fonte)(3000 - 0,25.Area + \varepsilon)$$

```{r, echo = TRUE}
set.seed(2)
area <- runif(100, min = 250, max = 10000)
venda <- rbinom(100, 1, .5)
vu <- (1-.15*venda)*(3000 - .25*area + rnorm(100, 0, 150))
dados <- data.frame(VU = vu, Area = area, 
                 Fonte = factor(venda, 
                                labels = c("Oferta", "Venda")))
```

--

## Como estimar o fator oferta?

---
# Estimação do Fator Oferta

### Test t para diferença entre duas médias

--

.pull-left[

* Antes da homogeneização:

```{r, echo = TRUE, highlight.output=11}
t.test(VU ~ Fonte, dados,
       alternative = "greater")
```

]

.pull-right[


* Após a homogeneização:

```{r, echo = TRUE, highlight.output=11}
dados <- within(dados, 
                VUhom <- ifelse(Fonte == "Oferta", 
                                .85*VU, VU))
t.test(VUhom ~ Fonte, dados,
       alternative = "greater")
```

]

--

* **Somente funciona devido à amostra ser balanceada (entre dados de ofertas e de 
transações)**.

---
# Estimação do Fator Oferta

## Forma numérica: minimização do CV

$$F_{oferta} = 1-\arg\min_{c \in \mathbb{R}_+} \left ( \frac{\sigma[(1- c\cdot F) VU]}{\mu[(1- c\cdot F) VU)]}\right ), \text{com } \, F = \left\{\begin{matrix}
1,\,\text{se dado de oferta}\\ 
0,\, \text{se dado de venda}
\end{matrix}\right.$$

--

```{r, fig.width=9, fig.height=4.5}
fator <- seq(.5, 2, by = .01)
cv <- vector(length = length(fator))
for (i in seq_along(fator)){
  df <- dados
  df <- within(df, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU, fator[i]*VU))
  cv[i] <- with(df, sd(VUhom)/mean(VUhom))
}
plotdata <- data.frame(CV = cv, fatorOferta = fator)
ggplot(plotdata, aes(x = fatorOferta, y = CV)) +
  geom_line(color = "blue", size = 1.5) +
  scale_x_continuous(breaks = seq(.5, 2.0, by = .05)) +
  geom_vline(xintercept = 1, color = "grey", lty = 3, size = .7) +
  geom_vline(xintercept = .85, color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$VU)/mean(dados$VU), 
             color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$VUhom)/mean(dados$VUhom), 
             color = "grey", lty = 3, size = .7) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


---
# Estimação do Fator Oferta

## Forma numérica:  minimização do CV

```{r minimize, echo = TRUE, eval = FALSE}
cv <- function(fator, vu, fonte){
  vuhom <- ifelse(fonte == "Venda", vu, fator*vu)
  sd(vuhom)/mean(vuhom)
}
optimise(cv, c(0.5, 2), tol = 0.0001, 
         vu = dados$VU, fonte = dados$Fonte)
```

--

```{r minimize, eval = TRUE, echo = FALSE}
```

---
# Estimação do Fator Oferta

## Modelo de regressão na forma direta 

* **Criação de dados de oferta e venda desbalanceados , com valores de oferta 
maiores, em média.**.


$$VU = (1 - 0,15.Fonte)(3000 - 0,25.Area + \varepsilon)$$

--

```{r, echo = TRUE}
set.seed(1)
areavenda <- runif(35, min = 1000, max = 10000)
areaoferta <-  runif(65, min = 250, max = 8000)
venda <- c(rep(0, 65), rep(1, 35))
vuvenda <- .85*(3000 - .25*areavenda + rnorm(35, 0, 150))
vuoferta <- 3000 - .25*areaoferta + rnorm(65, 0, 150)
vu <- c(vuoferta, vuvenda)
dados <- data.frame(VU = vu, Area = c(areaoferta, areavenda), 
                 Fonte = factor(venda, 
                                labels = c("Oferta", "Venda")))
```

---
# Estimação do Fator Oferta

### Test t para diferença entre duas médias

--

.pull-left[

* Antes da homogeneização:

```{r, echo = TRUE, highlight.output=11}
t.test(VU ~ Fonte, dados,
       alternative = "greater")
```

]

.pull-right[


* Após a homogeneização:

```{r, echo = TRUE, highlight.output=11}
dados <- within(dados, 
                VUhom <- ifelse(Fonte == "Oferta", 
                                .85*VU, VU))
t.test(VUhom ~ Fonte, dados,
       alternative = "greater")
```

]

---
# Estimação do Fator Oferta

## Forma numérica

$$F_{oferta} = 1-\arg\min_{c \in \mathbb{R}_+} \left ( \frac{\sigma[(1- c\cdot F) VU]}{\mu[(1- c\cdot F) VU)]}\right ), \text{com } \, F = \left\{\begin{matrix}
1,\,\text{se dado de oferta}\\ 
0,\, \text{se dado de venda}
\end{matrix}\right.$$

```{r, fig.width=9, fig.height=4.5}
fator <- seq(.5, 2, by = .01)
cv <- vector(length = length(fator))
for (i in seq_along(fator)){
  df <- dados
  df <- within(df, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU, fator[i]*VU))
  cv[i] <- with(df, sd(VUhom)/mean(VUhom))
}
plotdata <- data.frame(CV = cv, fatorOferta = fator)
ggplot(plotdata, aes(x = fatorOferta, y = CV)) +
  geom_line(color = "blue", size = 1.5) +
  scale_x_continuous(breaks = seq(.5, 2.0, by = .05)) +
  geom_vline(xintercept = 1, color = "grey", lty = 3, size = .7) +
  geom_vline(xintercept = .85, color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$VU)/mean(dados$VU), 
             color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$VUhom)/mean(dados$VUhom), 
             color = "grey", lty = 3, size = .7) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

---
# Estimação do Fator Oferta

## Análise Exploratória

```{r dados1, fig.cap="Dados randômicos de oferta (em vermelho) e transação (em verde)"}
p <- ggplot(dados, aes(x = Area, y = VU, colour = Fonte)) +
  geom_point() +
  stat_smooth(method = "lm", se = FALSE) + 
  theme(legend.position = "bottom")
p1 <- ggMarginal(p, type="boxplot", margins = "y", groupColour = T)
p1
```

---
# Estimação do Fator Oferta

## Forma gráfica

[App Fator Oferta](http://104.248.57.29/shiny/fatorOferta/)

---
# Estimação do Fator Oferta

## Regressão Linear

.pull-left[

### Modelo mal especificado

```{r, echo = TRUE}
fit <- lm(VU ~ Area + Fonte, data = dados)
S(fit, brief = T)
```

]

.pull-right[

```{r}
plot(fit, which = 1)
shapiro.test(residuals(fit))
```

]


---
# Estimação do Fator Oferta

## Modelo mal especificado

```{r dados1a, fig.cap="Dados randômicos de oferta (em vermelho) e transação (em verde)"}
ggplot(dados, aes(x = Area, y = VU)) +
  geom_abline(intercept = coef(fit)[1], slope = coef(fit)[2], 
              color = "red") +
  geom_abline(intercept = coef(fit)[1] + coef(fit)[3], slope = coef(fit)[2], 
              color = "blue") +
  geom_point(aes(color = Fonte))
```

---
# Estimação do Fator Oferta

## Regressão Linear

.pull-left[

### Modelo bem especificado

```{r, echo = TRUE}
fit1 <- lm(VU ~ Area*Fonte, data = dados)
S(fit1, brief = T)
```
]

.pull-right[

```{r}
plot(fit1, which = 1)
shapiro.test(residuals(fit1))
```

]

---
# Estimação do Fator Oferta

## Diferenças honestas de Tukey

.pull-left[

```{r, echo = TRUE, highlight.output=8}
fm <- aov(VU ~ Area*Fonte, 
           data = dados)
TukeyHSD(fm, "Fonte")
```

]

.pull-right[

```{r, echo = TRUE, highlight.output=8}
fm1 <- aov(VUhom ~ Area*Fonte, 
           data = dados)
TukeyHSD(fm1, "Fonte")
```

]



---
# Estimação do Fator Oferta

## Forma numérica: minimização das diferenças honestas de Tukey

```{r}
THSD <- function(fatorOferta, data, response = "VU", predictors = "Area", 
                 factor = "Fonte", level = "Venda", transf){
  dados <- data
  dados$yhom <- ifelse(dados[, factor] == level, 
                             dados[, response], 
                             fatorOferta*dados[, response])
  if (!missing(transf)){
    if (transf == "log"){
      termos <- c(predictors, factor)
    } else {
    termos <- vector(mode = "character", length = length(predictors))
      for (i in seq_along(predictors)){
        termos[[i]] <- paste(predictors[i], "*", factor, sep = "")
      }
    }
  } else {
      termos <- vector(mode = "character", length = length(predictors))
      for (i in seq_along(predictors)){
        termos[[i]] <- paste(predictors[i], "*", factor, sep = "")
      }
  }
  
  if (!missing(transf)) {
    resp <- paste(transf, "(yhom)", sep = "") 
  } else{
    resp <- "yhom"
  }
  
  f <- reformulate(termlabels = termos, response = resp)
  
  fm <- aov(f, data = dados)
  a <- TukeyHSD(fm, factor)
  abs(a[[factor]][, "diff"])
}
```


```{r minimizeTukeyHSD, echo = TRUE, eval = FALSE}
optimise(THSD, c(0.5, 2), tol = 0.0001, 
         data = dados, response = "VU", predictors = "Area",
          factor = "Fonte", level = "Venda")
```

--

```{r minimizeTukeyHSD, eval = TRUE, echo = FALSE}
```

---
# Estimação do Fator Oferta

## Aplicação prévia do fator oferta

.pull-left[

```{r, echo = TRUE}
dados <- within(dados, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU, 0.85*VU))
```

```{r, echo = TRUE}
fm <- aov(VUhom ~ Area*Fonte, dados)
summary(fm)
```


```{r, echo = TRUE}
# CV dados crus
sd(dados$VU)/mean(dados$VU)
```

]

.pull-right[

```{r dadosHomogeneizados, fig.cap="Dados homogeneizados."}
p <- ggplot(dados, aes(x = Area, y = VUhom, color = Fonte)) +
  geom_point() + 
  stat_smooth(method = "lm", se = FALSE) + 
  theme(legend.position = "bottom")
p1 <- ggMarginal(p, type="boxplot", margins = "y", groupColour = T)
p1
```


```{r, echo = TRUE}
# CV dados homogeneizados
sd(dados$VUhom)/mean(dados$VUhom)
```

]

---
# Estimação do Fator Oferta

## Aplicação prévia do fator oferta


```{r, echo = TRUE}
fithom <- lm(VUhom ~ Area, dados)
S(fithom, brief = T)
```

---
# Estimação do Fator Oferta

## Resumo

```{r, results='asis', include = FALSE}
stargazer(fit, fit1, fithom,
          header = FALSE, type = "html", table.placement = "H",
          title="Comparação dos modelos",
          #dep.var.labels=c("$log(Valor_{oferta})$","$log(Valor_{Hom})$"),
          ci = TRUE, ci.level = .80, report = "vcst*", single.row = T,
          intercept.bottom = FALSE, intercept.top = TRUE,
          decimal.mark = ",", digit.separator = ".",
          digits = 2, star.cutoffs = c(0.30, 0.20, 0.10),
          notes.label = "Notas:",
          font.size = "footnotesize"
          )
```

```{r}
tab_model(fit, fit1, fithom)
```


---
# Estimação do Fator Oferta

## Previsão de valores

.pull-left[

```{r, echo = TRUE, highlight.output=c(2)}
new250 <- 
  data.frame(Area = 250, Fonte = "Venda")
predict(fit, newdata = new250,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fit1, newdata = new250,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom, newdata = new250,
        interval = "confidence", level = .80)
```
]

.pull-right[

```{r, echo = TRUE, highlight.output=c(2)}
new10000 <- 
  data.frame(Area = 10000, Fonte = "Venda")
predict(fit, newdata = new10000,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fit1, newdata = new10000,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom, newdata = new10000,
        interval = "confidence", level = .80)
```

]

---
# Estimação do Fator Oferta

## Dados lognormais

--

Uma das propriedades da função logarítmica é: $\log(x \cdot y) = \log(x) + \log(y)$

--

Portanto, se $V_{venda} = 0,85\cdot V_{oferta}$, na escala $\log$:

--

$$\log(V_{venda}) = \log(0,85\cdot V_{oferta}) = \log (0,85) + \log(V_{oferta})$$

$$\log(V_{oferta}) = \log(V_{venda}) - \log(0,85)$$ 

--

$$\log(V_{oferta}) = \log(V_{venda}) - 0,1625$$

--

$$\log(VU) = 7,5 - 0,25\cdot \log(Area) - 0,1625\cdot Fonte + \varepsilon$$

--

```{r, echo = TRUE}
set.seed(2)
area <- runif(100, min = 250, max = 5000)
venda <- rbinom(100, 1, .5)
lvu <- 7.5 - .25*log(area) -.1625*venda + rnorm(100, mean = 0, sd = .05)
dados <- data.frame(VU = exp(lvu), Area = area, 
                 Fonte = factor(venda, labels = c("Oferta", "Venda")))
```

---
# Estimação do Fator Oferta

## Dados lognormais: análise exploratória

```{r lognormalExploratoria, fig.cap="Análise exploratória. Dados lognormais.", fig.width=9, fig.height=5.25}
p1 <- ggplot(dados, aes(x = Area, y = VU, color = Fonte)) + 
  geom_point() + 
  stat_smooth(se = FALSE)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
p1 <- p1 + theme(legend.position="none")
p1 <- ggMarginal(p1, type="boxplot", margins = "y", groupColour = T)
p2 <- ggplot(dados, aes(x = log(Area), y = log(VU), color = Fonte)) +
  geom_point() + stat_smooth(method = "lm", se = FALSE) +
  theme(legend.position="none")
p2 <- ggMarginal(p2, type="boxplot", margins = "y", groupColour = T)
prow <- plot_grid(
  p1,
  p2 ,
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)

plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```


---
# Estimação do Fator Oferta

.pull-left[

## Modelo bem especificado

```{r, echo = TRUE, highlight.output=5}
fit2 <- lm(log(VU) ~ log(Area) + Fonte, 
           data = dados)
S(fit2, brief = T)
```
]

.pull-right[

## Cálculo do Fator Oferta a partir do coeficiente estimado

```{r, echo = TRUE}
# Cálculo do Fator Oferta
exp(-.157503)
```
]

---
# Estimação do Fator Oferta

## Modelo bem especificado

```{r}
plot(predictorEffects(fit2, residuals=TRUE),
     partial.residuals=list(smooth=TRUE, span=0.5,  lty="dashed"),
     axes=list(grid=FALSE,x=list(rotate=30)))
```

---
# Estimação do Fator Oferta

## Modelo bem especificado

```{r fit2Diagnostics, fig.cap="Modelo correto. Fator oferta. Dados lognormais.",, fig.show = "hold", out.width="38%"}
plot(fit2)
```


---
# Estimação do Fator Oferta

## Aplicação prévia do Fator Oferta


```{r minimizeLog, echo = TRUE, eval = FALSE}
optimise(THSD, c(0.5, 2), tol = 0.0001, 
         data = dados, response = "VU", predictors = "log(Area)",
          factor = "Fonte", level = "Venda", transf = "log")
```

--

```{r minimizeLog, echo = FALSE}
```


---
# Estimação do Fator Oferta

## Aplicação prévia do Fator Oferta

.pull-left[
```{r, echo = TRUE}
dados <- within(dados, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU,  0.85*VU))
fithom2 <- lm(log(VUhom) ~ log(Area), dados)
S(fithom2, brief = T)
```
]

.pull-right[

```{r, echo = TRUE}
sd(dados$VU)/mean(dados$VU)
```

```{r, echo = TRUE}
sd(dados$VUhom)/mean(dados$VUhom)
```
]


---
# Estimação do Fator Oferta

## Aplicação prévia do fator oferta


```{r, fig.width=9, fig.height=5.5}
fator <- seq(.5, 2, by = .01)
CV <- vector(length = length(fator))
for (i in seq_along(fator)){
  df <- dados
  df <- within(df, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU, fator[i]*VU))
  CV[i] <- with(df, sd(VUhom)/mean(VUhom))
}
plotdata <- data.frame(CV = CV, fatorOferta = fator)
ggplot(plotdata, aes(x = fatorOferta, y = CV)) +
  geom_line(color = "blue", size = 1.5) +
  scale_x_continuous(breaks = seq(.5, 2.0, by = .05)) +
  geom_vline(xintercept = 1, color = "grey", lty = 3, size = .7) +
  geom_vline(xintercept = .85, color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$VU)/mean(dados$VU), 
             color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$VUhom)/mean(dados$VUhom), 
             color = "grey", lty = 3, size = .7) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


---
# Estimação do Fator Oferta

## Aplicação prévia do Fator Oferta

```{r, fig.width=9, fig.height=4.5}
p1 <- ggplot(dados, aes(x = Area, y = VUhom, color = Fonte)) +
  geom_point() +
  stat_smooth(se = FALSE)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
p1 <- p1 + theme(legend.position="none")
p1 <- ggMarginal(p1, type = "boxplot", margins = "y", groupColour = T)
p2 <- ggplot(dados, aes(x = log(Area), y = log(VUhom), color = Fonte)) +
  geom_point() +
  stat_smooth(method = "lm", se = FALSE) +
  theme(legend.position="none")
p2 <- ggMarginal(p2, type = "boxplot", margins = "y", groupColour = T)
prow <- plot_grid(
  p1,
  p2,
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---
# Estimação do Fator Oferta

## Diagnóstico modelo com dados homogeneizados

```{r fit2homDiagnostics, fig.cap="Modelo com dados homogeneizados. Dados lognormais.",, fig.show = "hold", out.width="38%"}
plot(fithom2)
```

---
# Estimação do Fator Oferta

## Resumo dos modelos

```{r}
tab_model(fit2, fithom2)
```

---
# Estimação do Fator Oferta

## Previsão de valores

.pull-left[

```{r, echo = TRUE, highlight.output=c(2)}
new250 <- 
  data.frame(Area = 250, Fonte = "Venda")
exp(predict(fit2, newdata = new250,
        interval = "confidence", level = .80))
```


```{r, echo = TRUE, highlight.output=c(2)}
exp(predict(fithom2, newdata = new250,
        interval = "confidence", level = .80))
```
]

.pull-right[

```{r, echo = TRUE, highlight.output=c(2)}
new5000 <- 
  data.frame(Area = 5000, Fonte = "Venda")
exp(predict(fit2, newdata = new5000,
        interval = "confidence", level = .80))
```

```{r, echo = TRUE, highlight.output=c(2)}
exp(predict(fithom2, newdata = new5000,
        interval = "confidence", level = .80))
```

]

---
# Estimação do Fator Oferta

## Outras transformações

$$VU = (1-0,15\cdot Fonte)(70 - 0,01\cdot Area + \varepsilon)^2$$

```{r, echo = TRUE}
set.seed(2)
area <- runif(100, min = 250, max = 5000)
venda <- rbinom(100, 1, .5)
sqrtvu <- 70 - .01*area + rnorm(100, mean = 0, sd = 2)
vu <- (1-.15*venda)*sqrtvu^2
dados <- data.frame(VU = vu, Area = area, 
                 Fonte = factor(venda, labels = c("Oferta", "Venda")))
```

---
# Estimação do Fator Oferta

## Outras transformações: análise exploratória

```{r, fig.width=9, fig.height=4.5}
p1 <- ggplot(dados, aes(x = Area, y = VU, color = Fonte)) +
  geom_point() + 
  stat_smooth(se = FALSE) + 
  theme(legend.position="none")
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
p1 <- ggMarginal(p1, type="boxplot", margins = "y", groupColour = T)
p2 <- ggplot(dados, aes(x = Area, y = sqrt(VU), color = Fonte)) +
  geom_point() + 
  stat_smooth(method = 'lm', se = FALSE) + 
  theme(legend.position="none")
p2 <- ggMarginal(p2, type="boxplot", margins = "y", groupColour = T)
prow <- plot_grid(
  p1,
  p2 ,
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---
# Modelo mal especificado

```{r, echo = TRUE}
fit3 <- lm(sqrt(VU) ~ Area + Fonte, data = dados)
S(fit3, brief = T)
```

---
# Modelo mal especificado

```{r fit3Diagnostics, fig.cap="Modelo mal especificado. Fator oferta.", fig.show="hold", out.width="38%"}
plot(fit3)
```

---
# Modelo correto

```{r, echo = TRUE}
fit4 <- lm(sqrt(VU) ~ Area*Fonte, data = dados)
S(fit4, brief = T)
```

---
# Modelo correto

```{r rightModel3, fig.cap="Fator oferta com transformação raiz quadrada. Modelo especificado corretamente.", fig.show = 'hold', out.width="50%"}
plot(predictorEffect("Area", fit4),
     lines=list(multiline=TRUE))
plot(predictorEffect("Area", fit4), 
     lines=list(multiline=TRUE),
     axes=list(y=list(transform=appraiseR::sqr, lab="VU")))
```

---
# Modelo correto

```{r fit4Diagnostics, fig.cap="Modelo mal especificado. Fator oferta.", fig.show="hold", out.width="38%"}
plot(fit4)
```


---
# Opção: aplicação prévia do fator oferta

```{r minimizesqrt, echo = TRUE, eval = FALSE}
optimise(THSD, c(0.5, 2), tol = 0.0001, 
         data = dados, response = "VU", predictors = "Area",
          factor = "Fonte", level = "Venda", transf = "sqrt")
```

--

```{r minimizesqrt, echo = FALSE}
```


---
# Opção: aplicação prévia do fator oferta

.pull-left[

```{r, echo = TRUE}
dados <- within(dados, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU, .85*VU))
fithom3 <- lm(sqrt(VUhom) ~ Area, dados)
S(fithom3, brief = T)
```

]

.pull-right[

* Coeficiente de variação dos dados crus:

```{r, echo = TRUE}
sd(dados$VU)/mean(dados$VU)
```

* Coeficiente de variação dos dados homogeneizados:

```{r, echo = TRUE}
sd(dados$VUhom)/mean(dados$VUhom)
```

]

---
# Opção: aplicação prévia do fator oferta

```{r, fig.width=9, fig.height=5.5}
fator <- seq(.5, 2, by = .01)
CV <- vector(length = length(fator))
for (i in seq_along(fator)){
  df <- dados
  df <- within(df, 
                VUhom <- ifelse(Fonte == "Venda", 
                                VU, fator[i]*VU))
  CV[i] <- with(df, sd(VUhom)/mean(VUhom))
}
plotdata <- data.frame(CV = CV, fatorOferta = fator)
ggplot(plotdata, aes(x = fatorOferta, y = CV)) +
  geom_line(color = "blue", size = 1.5) +
  scale_x_continuous(breaks = seq(.5, 2.0, by = .05)) +
  geom_vline(xintercept = 1, color = "grey", lty = 3, size = .7) +
  geom_vline(xintercept = .85, color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$VU)/mean(dados$VU), 
             color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$VUhom)/mean(dados$VUhom), 
             color = "grey", lty = 3, size = .7) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


---
# Opção: aplicação prévia do fator oferta

```{r dadosHomogeneizados3, fig.cap="Dados homogeneizados."}
p <- ggplot(dados, aes(x = Area, y = VUhom, color = Fonte)) +
  geom_point() + 
  stat_smooth(se = FALSE) +
  theme(legend.position = "bottom")
p <- ggMarginal(p, type = "boxplot", margins = "y", groupColour = T)
p
```

---
# Resumo

```{r, results='asis', include = FALSE}
stargazer(fit3, fit4, fithom3,
          header = FALSE, type = "html", table.placement = "H",
          title="Comparação dos modelos",
          #dep.var.labels=c("$log(Valor_{oferta})$","$log(Valor_{Hom})$"),
          ci = TRUE, ci.level = .80, report = "vcst*", single.row = T,
          intercept.bottom = FALSE, intercept.top = TRUE,
          decimal.mark = ",", digit.separator = ".",
          digits = 2, star.cutoffs = c(0.30, 0.20, 0.10),
          notes.label = "Notas:",
          font.size = "footnotesize"
          )
```

```{r}
tab_model(fit3, fit4, fithom3, digits = 3)
```

---
# Previsão de valores

.pull-left[

```{r, echo = TRUE, highlight.output=c(2)}
new250 <- 
  data.frame(Area = 250, Fonte = "Venda")
predict(fit3, newdata = new250,
        interval = "confidence", level = .80)^2
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fit4, newdata = new250,
        interval = "confidence", level = .80)^2
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom3, newdata = new250,
        interval = "confidence", level = .80)^2
```
]

.pull-right[

```{r, echo = TRUE, highlight.output=c(2)}
new5000 <- 
  data.frame(Area = 5000, Fonte = "Venda")
predict(fit3, newdata = new5000,
        interval = "confidence", level = .80)^2
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fit4, newdata = new5000,
        interval = "confidence", level = .80)^2
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom3, newdata = new5000,
        interval = "confidence", level = .80)^2
```

]

---
# Fator Oferta na regressão múltipla

```{r, echo = TRUE}
library(MASS)
##                X1       X2      Y
sigma <- matrix(c(16  ,    15,  10.2,
                  15  ,    25,    8,
                  10.2,     8,    9),
                ncol = 3, byrow = T)
set.seed(2)
dados <- mvrnorm(n=200,
              mu=c(100, 50, 30),
              Sigma=sigma)
colnames(dados) <- c("X1", "X2", "y")
dados <- as.data.frame(dados)
# cor(dados)
# cov(dados)
dados$Fonte <- rbinom(200, 1, .5)
dados$y <- (1 - .15*dados$Fonte)*dados$y
dados$Fonte <- factor(dados$Fonte, labels = c("Oferta", "Venda"))
```

```{r, echo=F, eval = F}
library(MASS)
##                X1       X2      Y
sigma <- matrix(c(16  ,    15,  9,
                  15  ,    25,  8,
                  9,     8,    9),
                ncol = 3, byrow = T)
set.seed(1)
dados <- mvrnorm(n=200,
              mu=c(100, 50, 30),
              Sigma=sigma)
colnames(dados) <- c("X1", "X2", "y")
dados <- as.data.frame(dados)
# cor(dados)
# cov(dados)
dados <- dados[order(dados$y), ]
fonte <- rbinom(150, 1, .5)
fonte <- c(rep(1, 25), fonte, rep(0, 25))
dados$Fonte <- fonte
dados$y <- (1 - .15*dados$Fonte)*dados$y
dados$Fonte <- factor(dados$Fonte, labels = c("Oferta", "Venda"))
```


---
# Análise Exploratória

```{r, fig.width=9, fig.height=6}
p1 <- ggplot(dados, aes(y = y, x = X1, color = Fonte)) +
  geom_point()
p2 <-  ggplot(dados, aes(y = y, x = X2, color = Fonte)) +
  geom_point()
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```


---
# Modelo mal especificado

```{r, echo = TRUE}
fitMult <- lm(y ~ X1 + X2 + Fonte, dados)
S(fitMult, brief = T)
```

---
# Modelo mal especificado

```{r fitMultDiagnostics, fig.cap="Modelo mal especificado. Fator oferta.",, out.width="38%", fig.show="hold"}
plot(fitMult)
```

---
# Resíduos Parciais

```{r}
library(broom)
coeffs <- coef(fitMult)
dadosAumentados <- augment(fitMult, dados)
```


$$p_i = r_i + \hat \beta_jX_i^{(j)}$$

```{r, fig.width=9, fig.height=5.5}
p1 <- ggplot(dadosAumentados, aes(x = X1, y = .resid + coeffs[2]*X1 + coeffs[1], 
                        color = Fonte)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  geom_abline(intercept = coeffs[1], slope = coeffs[2]) +
  labs(y = "Component + Partial Residuals")
p2 <- ggplot(dadosAumentados, aes(x = X2, y = .resid + coeffs[3]*X2 + coeffs[1], 
                        color = Fonte)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  geom_abline(intercept = coeffs[1], slope = coeffs[3]) +
  labs(y = "Component + Partial Residuals")
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---
# Modelo Correto

```{r, echo = TRUE}
fitMult2 <- lm(y ~ (X1 + X2)*Fonte, data = dados)
S(fitMult2, brief = T)
```

---
# Modelo Correto

```{r, fig.cap="Regressão Múltiplo. Modelo Correto. Fator Oferta.", out.width="50%", fig.show = "hold"}
plot(predictorEffect("X1", fitMult2),
     lines=list(multiline=TRUE))
plot(predictorEffect("X2", fitMult2), 
     lines=list(multiline=TRUE))
```

---
# Modelo Correto

```{r fitMul2tDiagnostics, fig.cap="Modelo mal especificado. Fator oferta.",, out.width="38%", fig.show="hold"}
plot(fitMult2)
```

---
# Opção: aplicação prévia do fator oferta

```{r}
THSDMult <- function(fatorOferta, data, valor = "VU", fator = "Fonte"){
  dados <- data
  dados$VUhom <- ifelse(dados[, fator] == "Venda", 
                             dados[, valor, drop=T], 
                             fatorOferta*dados[, valor, drop = T])
  fm <- aov(VUhom ~ Fonte*(X1 + X2), data = dados)
  a <- TukeyHSD(fm, fator)
  abs(a[[fator]][, "diff"])
}
```


```{r minimizeMultOld, echo = FALSE, eval = FALSE}
optimise(THSDMult, c(0.5, 2), tol = 0.0001, 
         data = dados, valor = "y", fator = "Fonte")
```

```{r minimizeMult, echo = TRUE, eval = FALSE}
optimise(THSD, c(0.5, 2), tol = 0.0001, 
         data = dados, response = "y", predictors = c("X1", "X2"),
          factor = "Fonte", level = "Venda")
```

--

```{r minimizeMult, echo = FALSE}
```

---
# Opção: aplicação prévia do fator oferta

.pull-left[

```{r, echo = TRUE}
dados <- within(dados, 
                yhom <- ifelse(Fonte == "Venda", 
                                y, .85*y))
fithom4 <- lm(yhom ~ X1 + X2, dados)
S(fithom4, brief = T)
```

]

.pull-right[

* Coeficiente de variação dos dados crus:

```{r, echo = TRUE}
sd(dados$y)/mean(dados$y)
```

* Coeficiente de variação dos dados homogeneizados:

```{r, echo = TRUE}
sd(dados$yhom)/mean(dados$yhom)
```

]

---
# Gráficos Modelo Homogeneizado

```{r}
coeffs <- coef(fithom4)
dados <- augment(fithom4, data = dados[, c("X1", "X2", "y", "yhom", "Fonte")])
```


```{r, fig.width=9, fig.height=5.5}
p1 <- ggplot(dados, aes(x = X1, y = .resid + coeffs[2]*X1 + coeffs[1], 
                        color = Fonte)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  geom_abline(intercept = coeffs[1], slope = coeffs[2]) +
  labs(y = "Component + Partial Residuals")
p2 <- ggplot(dados, aes(x = X2, y = .resid + coeffs[3]*X2 + coeffs[1], 
                        color = Fonte)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  geom_abline(intercept = coeffs[1], slope = coeffs[3]) +
  labs(y = "Component + Partial Residuals")
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---
# Previsão de valores

.pull-left[

```{r, echo = TRUE, highlight.output=c(2)}
new90_40 <- 
  data.frame(X1 = 90, X2 = 40, Fonte = "Venda")
predict(fitMult, newdata = new90_40,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fitMult2, newdata = new90_40,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom4, newdata = new90_40,
        interval = "confidence", level = .80)
```
]

.pull-right[

```{r, echo = TRUE, highlight.output=c(2)}
new110_60 <- 
  data.frame(X1 = 110, X2 = 60, Fonte = "Venda")
predict(fitMult, newdata = new110_60,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fitMult2, newdata = new110_60,
        interval = "confidence", level = .80)
```

```{r, echo = TRUE, highlight.output=c(2)}
predict(fithom4, newdata = new110_60,
        interval = "confidence", level = .80)
```

]

---
# Fator oferta minimiza o CV na RLM?

[App Fator Oferta 2](http://104.248.57.29/shiny/fatorOferta2/)

--

```{r, fig.width=9, fig.height=5.5}
fator <- seq(.5, 2, by = .01)
CV <- vector(length = length(fator))
for (i in seq_along(fator)){
  df <- dados
  df <- within(df, 
                yhom <- ifelse(Fonte == "Venda", 
                                y, fator[i]*y))
  CV[i] <- with(df, sd(yhom)/mean(yhom))
}
plotdata <- data.frame(CV = CV, fatorOferta = fator)
ggplot(plotdata, aes(x = fatorOferta, y = CV)) +
  geom_line(color = "blue", size = 1.5) +
  scale_x_continuous(breaks = seq(.5, 2.0, by = .05)) +
  geom_vline(xintercept = 1, color = "grey", lty = 3, size = .7) +
  geom_vline(xintercept = .85, color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$y)/mean(dados$y), 
             color = "grey", lty = 3, size = .7) +
  geom_hline(yintercept = sd(dados$yhom)/mean(dados$yhom), 
             color = "grey", lty = 3, size = .7) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


---
# Efeito da omissão de variáveis relevantes na estimação do fator oferta

```{r, echo = TRUE}
set.seed(1)
area <- runif(200, min = 250, max = 5000)
distancia <- runif(200, min = 10, max = 500)
venda <- rbinom(200, 1, .5)
lvu <- 7.5 - .25*log(area) -.25*log(distancia) - .1625*venda + rnorm(200, mean = 0, sd = .05)
dados <- data.frame(VU = exp(lvu), Area = area, Distancia = distancia,
                 Fonte = factor(venda, labels = c("Oferta", "Venda")))
```

--

```{r, echo = TRUE}
fitComplete <- lm(log(VU) ~ log(Area) + log(Distancia) + Fonte, dados)
fitOVB <- lm(log(VU) ~ log(Area) + Fonte, dados)
```

---
# Efeito da omissão de variáveis relevantes na estimação do fator oferta

```{r}
tab_model(fitComplete, fitOVB)
```


--

* A estimativa central não muda muito, mesmo com o viés devido à omissão da variável;

--

* A eficiência da estimação, no entanto, é bem inferior à obtida com o modelo completo.

---
# Obtenção à partir da minimização das THSD


```{r minimizeOVB, echo = TRUE, eval = FALSE}
optimise(THSD, c(0.5, 2), tol = 0.0001, 
         data = dados, response = "VU", predictors = "log(Area)",
          factor = "Fonte", level = "Venda", transf = "log")
```

--

```{r minimizeOVB, echo = FALSE}
```

--

```{r minimizeOVB2, echo = TRUE, eval = FALSE}
optimise(THSD, c(0.5, 2), tol = 0.0001, 
         data = dados, response = "VU", predictors = c("log(Area)", "log(Distancia)"),
          factor = "Fonte", level = "Venda", transf = "log")
```


--

```{r minimizeOVB2, echo = FALSE}
```

---
class: inverse, center, middle

# Estudo de caso

---
# Estudo de Caso

## Dados de Atibaia/SP `r AutoCite(bib, 'mantovani2019')`

```{r}
library(readxl)
atibaia <- read_excel('Atibaia.xlsx')
atibaia <- within(atibaia, {
  VUoferta <- ValorOfertado/AreaConstruida
  VUvenda <- ValorVendido/AreaConstruida
  FatorOferta <- ValorVendido/ValorOfertado
  PC <- PadraoConstrutivo
})
# library("ggpubr")
# ggboxplot(atibaia, x = "PC", y = "VU", color = "Fonte",
#           palette = c("#00AFBB", "#E7B800"))
ggplot(atibaia, aes(y = FatorOferta,
                    x=PC, color = PC)) +
  geom_boxplot()
# ggplot(atibaia, aes(y = FatorOferta, 
#                     x=AreaConstruida, color = PC)) +
#   geom_point()
# fit <- lm(log(ValorVendido/ValorOfertado) ~ log(AreaConstruida), 
#           data = atibaia)
# summary(fit)
```

---
# Estudo de Caso

## Análise Exploratória


```{r}
p1 <- ggplot(atibaia, aes(x = log(AreaConstruida), y = log(VUoferta), 
                 colour = PC), pch = 21) +
  geom_point(alpha = .5) + 
  stat_smooth(method = "lm", se = FALSE, lty = 2) +
  geom_point(data = atibaia, 
             aes(x = log(AreaConstruida), 
                 y = log(VUvenda), 
                 colour = PC), pch = 17) +
  stat_smooth(data = atibaia, aes(x = log(AreaConstruida), 
                                  y = log(VUvenda),
                                  colour = PC),
              method = "lm", se = F)
p2 <- ggplot(atibaia, aes(x = log(IndiceFiscal), y = log(VUoferta), 
                 colour = PC), pch = 21) +
  geom_point(alpha = .5) + 
  stat_smooth(method = "lm", se = FALSE, lty = 2) +
  geom_point(data = atibaia, 
             aes(x = log(IndiceFiscal), 
                 y = log(VUvenda), 
                 colour = PC), pch = 17) +
  stat_smooth(data = atibaia, aes(x = log(AreaConstruida), 
                                  y = log(VUvenda),
                                  colour = PC),
              method = "lm", se = F)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)

plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---
# Ajuste de modelos

```{r, echo = T}
fitOferta <- lm(log(VUoferta)~ log(IndiceFiscal) + log(AreaConstruida) + PC,
                data = atibaia, subset = -60)

fitVenda <- lm(log(VUvenda)~ log(IndiceFiscal) + log(AreaConstruida) + PC,
               data = atibaia, subset = -60)
```


---
# Resíduos Parciais

## Model de Oferta

```{r}
coeffs <- coef(fitOferta)
Oferta <- augment(fitOferta, atibaia[-60, ])
```


```{r, fig.width=9, fig.height=5.5}
p1 <- ggplot(Oferta, aes(x = log(AreaConstruida), 
                        y = .resid + coeffs[3]*log(AreaConstruida) + coeffs[1], 
                        color = PC)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  scale_y_continuous(limits = c(6.5, 10.2)) +
  geom_abline(intercept = coeffs[1], slope = coeffs[3]) +
  labs(y = "Component + Partial Residuals")
p2 <- ggplot(Oferta, aes(x = log(IndiceFiscal), 
                        y = .resid + coeffs[2]*log(IndiceFiscal) + coeffs[1], 
                        color = PC)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  geom_abline(intercept = coeffs[1], slope = coeffs[2]) +
  scale_y_continuous(limits = c(9.75, 11.25)) +
  labs(y = "Component + Partial Residuals")
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---
# Resíduos Parciais

## Model de Venda

```{r}
coeffs <- coef(fitVenda)
Venda <- augment(fitVenda, atibaia[-60,])
```


```{r, fig.width=9, fig.height=5.5}
p1 <- ggplot(Venda, aes(x = log(AreaConstruida), 
                        y = .resid + coeffs[3]*log(AreaConstruida) + coeffs[1], 
                        color = PC)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  geom_abline(intercept = coeffs[1], slope = coeffs[3]) +
  scale_y_continuous(limits = c(6.5, 10.2)) +
  labs(y = "Component + Partial Residuals")
p2 <- ggplot(Venda, aes(x = log(IndiceFiscal), 
                        y = .resid + coeffs[2]*log(IndiceFiscal) + coeffs[1], 
                        color = PC)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point() +
  geom_abline(intercept = coeffs[1], slope = coeffs[2]) +
  scale_y_continuous(limits = c(9.75, 11.25)) +
  labs(y = "Component + Partial Residuals")
prow <- plot_grid(
  p1 + theme(legend.position="none"),
  p2 + theme(legend.position="none"),
  align = 'vh',
  labels = c("A", "B"),
  hjust = -1,
  nrow = 1
)
legend <- get_legend(
  p1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)
plot_grid(prow, legend, ncol = 1, rel_heights = c(1, .1))
```

---

```{r}
plot(predictorEffects(fitOferta),
     axes=list(y=list(transform=exp, lab="VUOferta")))
```

---

```{r}
plot(predictorEffects(fitVenda), 
     axes=list(y=list(transform=exp, lab="VUVenda")))
```

---
# Estimação do Fator Oferta

## Resumo

```{r}
tab_model(fitOferta, fitVenda)
```

--

### E agora? Como estimar o fator oferta???

---
# Estimação do Fator Oferta


```{r}
linearHypothesis(fitOferta, c("log(IndiceFiscal) = 0.10", 
                 "log(AreaConstruida) = -.46"))
```

--

## Modelos restritos


```{r, echo = T}
RfitVenda <- lm(log(VUvenda) ~ offset(.1*log(IndiceFiscal)) + offset(-.46*log(AreaConstruida)) +
                 PC, data = atibaia, subset = -60)
RfitOferta <- lm(log(VUoferta) ~ offset(.1*log(IndiceFiscal)) + offset(-.46*log(AreaConstruida)) +
                 PC, data = atibaia, subset = -60)
```

---
# Estimação do Fator Oferta

.pull-left[

```{r}
tab_model(RfitVenda, RfitOferta, digits = 3,
          show.ci = FALSE, show.p = FALSE)
```

* Padrão Fino:

```{r, echo = T}
exp(10.157 - 10.262)
```

]

.pull-right[


* Padrão Médio:

```{r, echo = T}
exp((10.157 - .387) - (10.262 - .431))
```

* Padrão Simples:

```{r, echo = T}
exp((10.157 - .725) - (10.262 - .773))
```

* Padrão Superior:
```{r, echo = T}
exp((10.157 - .346) - (10.262 - .376))
```

]

---
# Estimação do Fator Oferta

## Adoção dos coeficientes do modelo de oferta

```{r}
linearHypothesis(fitVenda, c("log(IndiceFiscal) = 0.11", 
                 "log(AreaConstruida) = -.39"))
```

--
# Estimação do Fator Oferta

## Modelos restritos


```{r, echo = T}
RfitVenda2 <- lm(log(VUvenda) ~ offset(.11*log(IndiceFiscal)) + offset(-.39*log(AreaConstruida)) +
                 PC, data = atibaia, subset = -60)
RfitOferta2 <- lm(log(VUoferta) ~ offset(.11*log(IndiceFiscal)) + offset(-.39*log(AreaConstruida)) +
                 PC, data = atibaia, subset = -60)
```

---
# Estimação do Fator Oferta

.pull-left[

```{r}
tab_model(RfitVenda2, RfitOferta2, digits = 3,
          show.ci = FALSE, show.p = FALSE)
```

* Padrão Fino:

```{r, echo = T}
exp(9.707 - 9.812)
```

]

.pull-right[


* Padrão Médio:

```{r, echo = T}
exp((9.707 - .341) - (9.812 - .384))
```

* Padrão Simples:

```{r, echo = T}
exp((9.707 - .602) - (9.812 - .649))
```

* Padrão Superior:
```{r, echo = T}
exp((9.707 - .351) - (9.812 - .381))
```

]

---
class: inverse, center, middle

# Efeitos do Fator Oferta sobre IC e IP


---
# Efeitos do Fator Oferta sobre IC e IP

$$\mathbb{E}[c \cdot VU] = c\mathbb{E}[VU]$$

--

$$\mathbb{E}[VU_{venda}] = \mathbb{E}[c\cdot VU_{oferta}] = c \mathbb{E}[VU_{oferta}]$$

--

$$\mathbb{V}[c \cdot VU] = c^2\mathbb{V}[VU]$$

--

$$\mathbb{V}[VU_{venda}] = \mathbb{V}[c\cdot VU_{oferta}] = c^2 \mathbb{V}[VU_{oferta}]$$

--

* Intervalos de Confiança `r AutoCite(bib, 'matloff2009')`:

$$IC_\alpha = \hat\theta \pm Z_{1 - \frac{\alpha}{2}} s.e.(\hat \theta)$$
--

* $s.e.(\hat \theta) = \frac{s}{\sqrt{n}} \, , \text{onde} \, s\, \text{é o desvio-padrão amostral}$

* $\mathbb{\hat V}(\hat \theta) = \frac{s^2}{n}$

* $s.e.(\hat \theta) = \sqrt{\mathbb{\hat V}(\hat \theta)}$

---
# Efeitos do Fator Oferta sobre IC e IP

* $s.e.(\hat{VU}_{venda}) = s.e.(c \hat{VU}_{oferta}) = \sqrt{\mathbb{\hat V}(c \hat{VU}_{oferta})}$

--

* $s.e.(\hat{VU}_{venda}) = \sqrt{c^2\mathbb{\hat V} (\hat{VU}_{oferta})}$

--

* $s.e.(\hat{VU}_{venda}) = c\sqrt{\mathbb{\hat V} (\hat{VU}_{oferta})} = c\cdot s.e.(\hat{VU}_{oferta})$

--

* O IC dos valores de venda, portanto, pode ser escrito assim:

$$IC_{VU_{venda}} = \hat{VU}_{venda} \pm Z_{1 - \frac{\alpha}{2}} s.e.(\hat{VU}_{venda})$$

--
* Ou assim:

$$IC_{VU_{venda}} = c \cdot \hat{VU}_{oferta} \pm Z_{1 - \frac{\alpha}{2}} \cdot c \cdot s.e.(\hat{VU}_{oferta})$$

--

* Em suma:

$$IC_{VU_{venda}} = c \cdot IC_{VU_{oferta}}$$

---
# Efeitos do Fator Oferta sobre IC e IP

* Dados exclusivamente de ofertas:

```{r, echo = TRUE}
set.seed(2)
area <- runif(100, min = 250, max = 10000); vu <- 3000 - .25*area + rnorm(100, 0, 2000)
dados <- data.frame(VU = vu, Area = area)
```

--


.pull-left[

* Avaliador A:

```{r, echo = TRUE, highlight.output=2}
dados$VUvenda <- .9*dados$VU
fit <- lm(VUvenda ~ Area, data = dados)
p <- predict(fit, 
        newdata = data.frame(Area = 5000),
        interval = "confidence", level = .80)
p
```

]

.pull-right[

* Avaliador B:

```{r, echo = TRUE}
fit1 <- lm(VU ~ Area, data = dados)
p1 <- predict(fit1, 
            newdata = data.frame(Area = 5000),
            interval = "confidence", level = .80)
p1
```
```{r, echo = TRUE, highlight.output=2}
.9*p1
```


]

---
class: inverse, center, middle

# Conclusão

---
# Conclusão

* A estimação e aplicação do Fator Oferta deve ser feita com cuidado. 
  - Deve-se ter em mente que assumir que $V_{venda} = \lambda V_{oferta}$ é 
  apenas uma hipótese, que deve ser verificada.
  
--

* A análise exploratória é fundamental para a percepção da realidade do mercado
antes da modelagem.

--

* A modelagem deve levar em conta a hipótese feita para o fator oferta.
  - A má especificação do fator oferta pode levar a modelos tendenciosos, que 
podem produzir más previsões de valores, especialmente nos extremos da amostra.

--

* A eventual obtenção do fator oferta previamente à modelagem é benéfica.
  - Modelos ficam mais simples e interpretáveis.

--
  
* Quando possível, deve ser investigada a possível existência de fatores 
diferentes, de acordo com a tipologia, o padrão construtivo, etc.

--

* A transformação logarítimica da variável dependente permite
uma estimação menos custosa do fator oferta.

---
# Conclusão

* Quando da utilização exclusiva de dados de oferta, a aplicação do fator oferta
antes ou após o ajuste do modelo de regressão deveria conduzir aos mesmos
valores previstos, tanto para a estimativa central, quanto para os limites dos
intervalos de confiança e predição. A norma deveria estabelecer este 
procedimento explicitamente.

---
class: scrollable-slide

# Referências

```{r results = "asis", echo = FALSE}
PrintBibliography(bib, .opts = list(check.entries = FALSE, sorting = "nyt"))
```


---
class: center, middle, inverse

# OBRIGADO!